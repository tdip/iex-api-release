"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const rxjs_1 = require("rxjs");
const socketIO = require("socket.io-client");
/**
 * Create an entry containing an observer that will emit values
 * produced by Socket.IO
 * @param handler Object specified what to do when the first observer
 * subscribes to the topic or when all observers unsubscribe
 */
const createEntry = (handler) => {
    const observers = [];
    const observable = rxjs_1.Observable.create((observer) => {
        observers.push(observer);
        if (observers.length === 1) {
            handler.onResumend();
        }
        return () => {
            const ix = observers.findIndex(_observer => observer === _observer);
            if (ix >= 0) {
                observers.splice(ix, 1);
                if (observers.length === 0) {
                    handler.onEmpty();
                }
            }
        };
    });
    return {
        observable,
        next(value) {
            observers.forEach(o => o.next(value));
        },
        complete() {
            observers.forEach(o => o.complete());
            observers.splice(0, observers.length);
        },
        get count() {
            return observers.length;
        }
    };
};
const endpoint = 'https://ws-api.iextrading.com/1.0/tops';
/**
 * Client for observing realtime data streams
 * produced by IEX.
 */
class IEXClientRT {
    constructor(socketBuilder) {
        this.onConnect = this.onConnect.bind(this);
        this.onMessage = this.onMessage.bind(this);
        this.subscribePending = this.subscribePending.bind(this);
        this.subscribeIfReady = this.subscribeIfReady.bind(this);
        this.getOrCreateObservable = this.getOrCreateObservable.bind(this);
        this.observe = this.observe.bind(this);
        this.isReady = false;
        this.subscriptions = {};
        socketBuilder = socketBuilder || socketIO;
        this.socket = socketBuilder(endpoint);
        this.socket.on('connect', this.onConnect);
        this.socket.on('message', this.onMessage);
    }
    onMessage(_message) {
        const message = JSON.parse(_message);
        const topic = message.symbol;
        const entry = this.subscriptions[topic];
        if (entry) {
            entry.next(message);
        }
    }
    onConnect() {
        this.isReady = true;
        this.subscribePending();
    }
    subscribePending() {
        const pending = Object.keys(this.subscriptions)
            .filter(key => this.subscriptions[key].count > 0);
        if (pending.length > 0) {
            this.socket.emit('subscribe', pending.join());
        }
    }
    subscribeIfReady(topic) {
        if (!this.isReady) {
            return;
        }
        this.socket.emit('subscribe', topic);
    }
    getOrCreateObservable(topic) {
        topic = topic.toUpperCase();
        let observable = this.subscriptions[topic];
        if (!observable) {
            this.subscriptions[topic] = observable = createEntry({
                onResumend: () => this.subscribeIfReady(topic),
                onEmpty: () => this.socket.emit('unsubscribe', topic)
            });
        }
        return observable.observable;
    }
    /**
     * Get an Observable that produces values whenever one of the
     * securities passed as parameter changes
     * @param topics The securities one wishes to subscribe
     */
    observe(...topics) {
        return rxjs_1.merge(...topics.map(this.getOrCreateObservable));
    }
}
exports.default = IEXClientRT;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiSUVYQ2xpZW50UlQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvSUVYQ2xpZW50UlQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSwrQkFBa0Q7QUFDbEQsNkNBQTRDO0FBb0I1Qzs7Ozs7R0FLRztBQUNILE1BQU0sV0FBVyxHQUFHLENBQUMsT0FBcUIsRUFBRSxFQUFFO0lBQzFDLE1BQU0sU0FBUyxHQUEyQyxFQUFFLENBQUM7SUFDN0QsTUFBTSxVQUFVLEdBQUcsaUJBQVUsQ0FBQyxNQUFNLENBQUMsQ0FBQyxRQUF5QyxFQUFFLEVBQUU7UUFDL0UsU0FBUyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUN6QixJQUFHLFNBQVMsQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFDO1lBQ3RCLE9BQU8sQ0FBQyxVQUFVLEVBQUUsQ0FBQztTQUN4QjtRQUVELE9BQU8sR0FBRyxFQUFFO1lBQ1IsTUFBTSxFQUFFLEdBQUcsU0FBUyxDQUFDLFNBQVMsQ0FBQyxTQUFTLENBQUMsRUFBRSxDQUFDLFFBQVEsS0FBSyxTQUFTLENBQUMsQ0FBQztZQUVwRSxJQUFHLEVBQUUsSUFBSSxDQUFDLEVBQUM7Z0JBQ1AsU0FBUyxDQUFDLE1BQU0sQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUM7Z0JBRXhCLElBQUcsU0FBUyxDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUM7b0JBQ3RCLE9BQU8sQ0FBQyxPQUFPLEVBQUUsQ0FBQztpQkFDckI7YUFDSjtRQUNMLENBQUMsQ0FBQTtJQUNMLENBQUMsQ0FBQyxDQUFDO0lBRUgsT0FBTztRQUNILFVBQVU7UUFDVixJQUFJLENBQUMsS0FBNEI7WUFDN0IsU0FBUyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztRQUMxQyxDQUFDO1FBQ0QsUUFBUTtZQUNKLFNBQVMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFD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LHFCQUFxQixDQUFDLEtBQWE7UUFDdkMsS0FBSyxHQUFHLEtBQUssQ0FBQyxXQUFXLEVBQUUsQ0FBQztRQUM1QixJQUFJLFVBQVUsR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBRTNDLElBQUcsQ0FBQyxVQUFVLEVBQUM7WUFDWCxJQUFJLENBQUMsYUFBYSxDQUFDLEtBQUssQ0FBQyxHQUFHLFVBQVUsR0FBRyxXQUFXLENBQUM7Z0JBQ2pELFVBQVUsRUFBRSxHQUFHLEVBQUUsQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsS0FBSyxDQUFDO2dCQUM5QyxPQUFPLEVBQUUsR0FBRyxFQUFFLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsYUFBYSxFQUFFLEtBQUssQ0FBQzthQUN4RCxDQUFDLENBQUM7U0FDTjtRQUVELE9BQU8sVUFBVSxDQUFDLFVBQVUsQ0FBQztJQUNqQyxDQUFDO0lBRUQ7Ozs7T0FJRztJQUNJLE9BQU8sQ0FBQyxHQUFHLE1BQWdCO1FBQzlCLE9BQU8sWUFBSyxDQUFDLEdBQUcsTUFBTSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMscUJBQXFCLENBQUMsQ0FBQyxDQUFDO0lBQzVELENBQUM7Q0FDSjtBQTdFRCw4QkE2RUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBtZXJnZSwgT2JzZXJ2YWJsZSwgT2JzZXJ2ZXIgfSBmcm9tICdyeGpzJ1xuaW1wb3J0ICogYXMgc29ja2V0SU8gZnJvbSAnc29ja2V0LmlvLWNsaWVudCdcblxuaW1wb3J0IHsgUmVhbHRpbWVRdW90ZVJlc3BvbnNlIH0gZnJvbSAnLi9hcGlzL3N0b2NrcydcblxuaW50ZXJmYWNlIFN1YnNjcmlwdGlvbkVudHJ5e1xuICAgIHJlYWRvbmx5IG9ic2VydmFibGU6IE9ic2VydmFibGU8UmVhbHRpbWVRdW90ZVJlc3BvbnNlPixcbiAgICBuZXh0KHZhbHVlOiBSZWFsdGltZVF1b3RlUmVzcG9uc2UpOiBhbnksXG4gICAgY29tcGxldGUoKTogYW55LFxuICAgIHJlYWRvbmx5IGNvdW50OiBudW1iZXJcbn1cblxuaW50ZXJmYWNlIFN1YnNjcmlwdGlvbnN7XG4gICAgW3RvcGljOiBzdHJpbmddOiBTdWJzY3JpcHRpb25FbnRyeVxufVxuXG5pbnRlcmZhY2UgRW50cnlIYW5kbGVye1xuICAgIG9uRW1wdHkoKTogYW55LFxuICAgIG9uUmVzdW1lbmQoKTogYW55XG59XG5cbi8qKlxuICogQ3JlYXRlIGFuIGVudHJ5IGNvbnRhaW5pbmcgYW4gb2JzZXJ2ZXIgdGhhdCB3aWxsIGVtaXQgdmFsdWVzXG4gKiBwcm9kdWNlZCBieSBTb2NrZXQuSU9cbiAqIEBwYXJhbSBoYW5kbGVyIE9iamVjdCBzcGVjaWZpZWQgd2hhdCB0byBkbyB3aGVuIHRoZSBmaXJzdCBvYnNlcnZlclxuICogc3Vic2NyaWJlcyB0byB0aGUgdG9waWMgb3Igd2hlbiBhbGwgb2JzZXJ2ZXJzIHVuc3Vic2NyaWJlXG4gKi9cbmNvbnN0IGNyZWF0ZUVudHJ5ID0gKGhhbmRsZXI6IEVudHJ5SGFuZGxlcikgPT4ge1xuICAgIGNvbnN0IG9ic2VydmVyczogQXJyYXk8T2JzZXJ2ZXI8UmVhbHRpbWVRdW90ZVJlc3BvbnNlPj4gPSBbXTtcbiAgICBjb25zdCBvYnNlcnZhYmxlID0gT2JzZXJ2YWJsZS5jcmVhdGUoKG9ic2VydmVyOiBPYnNlcnZlcjxSZWFsdGltZVF1b3RlUmVzcG9uc2U+KSA9PiB7XG4gICAgICAgIG9ic2VydmVycy5wdXNoKG9ic2VydmVyKTtcbiAgICAgICAgaWYob2JzZXJ2ZXJzLmxlbmd0aCA9PT0gMSl7XG4gICAgICAgICAgICBoYW5kbGVyLm9uUmVzdW1lbmQoKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiAoKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBpeCA9IG9ic2VydmVycy5maW5kSW5kZXgoX29ic2VydmVyID0+IG9ic2VydmVyID09PSBfb2JzZXJ2ZXIpO1xuXG4gICAgICAgICAgICBpZihpeCA+PSAwKXtcbiAgICAgICAgICAgICAgICBvYnNlcnZlcnMuc3BsaWNlKGl4LCAxKTtcblxuICAgICAgICAgICAgICAgIGlmKG9ic2VydmVycy5sZW5ndGggPT09IDApe1xuICAgICAgICAgICAgICAgICAgICBoYW5kbGVyLm9uRW1wdHkoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9KTtcblxuICAgIHJldHVybiB7XG4gICAgICAgIG9ic2VydmFibGUsXG4gICAgICAgIG5leHQodmFsdWU6IFJlYWx0aW1lUXVvdGVSZXNwb25zZSl7XG4gICAgICAgICAgICBvYnNlcnZlcnMuZm9yRWFjaChvID0+IG8ubmV4dCh2YWx1ZSkpO1xuICAgICAgICB9LFxuICAgICAgICBjb21wbGV0ZSgpe1xuICAgICAgICAgICAgb2JzZXJ2ZXJzLmZvckVhY2gobyA9PiBvLmNvbXBsZXRlKCkpO1xuICAgICAgICAgICAgb2JzZXJ2ZXJzLnNwbGljZSgwLCBvYnNlcnZlcnMubGVuZ3RoKTtcbiAgICAgICAgfSxcbiAgICAgICAgZ2V0IGNvdW50KCl7XG4gICAgICAgICAgICByZXR1cm4gb2JzZXJ2ZXJzLmxlbmd0aDtcbiAgICAgICAgfVxuICAgIH1cbn1cblxuY29uc3QgZW5kcG9pbnQgPSAnaHR0cHM6Ly93cy1hcGkuaWV4dHJhZGluZy5jb20vMS4wL3RvcHMnO1xuXG5leHBvcnQgdHlwZSBTb2NrZXRJT0J1aWxkZXIgPSAoZW5kcG9pbnQ6IHN0cmluZykgPT4gU29ja2V0SU9DbGllbnQuU29ja2V0O1xuXG4vKipcbiAqIENsaWVudCBmb3Igb2JzZXJ2aW5nIHJlYWx0aW1lIGRhdGEgc3RyZWFtc1xuICogcHJvZHVjZWQgYnkgSUVYLlxuICovXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBJRVhDbGllbnRSVHtcblxuICAgIHByaXZhdGUgaXNSZWFkeTogYm9vbGVhbjtcblxuICAgIHByaXZhdGUgcmVhZG9ubHkgc29ja2V0OiBTb2NrZXRJT0NsaWVudC5Tb2NrZXQ7XG5cbiAgICBwcml2YXRlIHJlYWRvbmx5IHN1YnNjcmlwdGlvbnM6IFN1YnNjcmlwdGlvbnM7XG5cbiAgICBjb25zdHJ1Y3Rvcihzb2NrZXRCdWlsZGVyPzogU29ja2V0SU9CdWlsZGVyKXtcbiAgICAgICAgdGhpcy5vbkNvbm5lY3QgPSB0aGlzLm9uQ29ubmVjdC5iaW5kKHRoaXMpO1xuICAgICAgICB0aGlzLm9uTWVzc2FnZSA9IHRoaXMub25NZXNzYWdlLmJpbmQodGhpcyk7XG4gICAgICAgIHRoaXMuc3Vic2NyaWJlUGVuZGluZyA9IHRoaXMuc3Vic2NyaWJlUGVuZGluZy5iaW5kKHRoaXMpO1xuICAgICAgICB0aGlzLnN1YnNjcmliZUlmUmVhZHkgPSB0aGlzLnN1YnNjcmliZUlmUmVhZHkuYmluZCh0aGlzKTtcbiAgICAgICAgdGhpcy5nZXRPckNyZWF0ZU9ic2VydmFibGUgPSB0aGlzLmdldE9yQ3JlYXRlT2JzZXJ2YWJsZS5iaW5kKHRoaXMpO1xuICAgICAgICB0aGlzLm9ic2VydmUgPSB0aGlzLm9ic2VydmUuYmluZCh0aGlzKTtcblxuICAgICAgICB0aGlzLmlzUmVhZHkgPSBmYWxzZTtcbiAgICAgICAgdGhpcy5zdWJzY3JpcHRpb25zID0ge307XG4gICAgICAgIHNvY2tldEJ1aWxkZXIgPSBzb2NrZXRCdWlsZGVyIHx8IHNvY2tldElPO1xuICAgICAgICB0aGlzLnNvY2tldCA9IHNvY2tldEJ1aWxkZXIoZW5kcG9pbnQpO1xuICAgICAgICB0aGlzLnNvY2tldC5vbignY29ubmVjdCcsIHRoaXMub25Db25uZWN0KTtcbiAgICAgICAgdGhpcy5zb2NrZXQub24oJ21lc3NhZ2UnLCB0aGlzLm9uTWVzc2FnZSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBvbk1lc3NhZ2UoX21lc3NhZ2U6IHN0cmluZyl7XG4gICAgICAgIGNvbnN0IG1lc3NhZ2UgPSBKU09OLnBhcnNlKF9tZXNzYWdlKTtcbiAgICAgICAgY29uc3QgdG9waWMgPSBtZXNzYWdlLnN5bWJvbDtcbiAgICAgICAgY29uc3QgZW50cnkgPSB0aGlzLnN1YnNjcmlwdGlvbnNbdG9waWNdO1xuICAgICAgICBpZihlbnRyeSl7XG4gICAgICAgICAgICBlbnRyeS5uZXh0KG1lc3NhZ2UpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBvbkNvbm5lY3QoKXtcbiAgICAgICAgdGhpcy5pc1JlYWR5ID0gdHJ1ZTtcbiAgICAgICAgdGhpcy5zdWJzY3JpYmVQZW5kaW5nKCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBzdWJzY3JpYmVQZW5kaW5nKCl7XG4gICAgICAgIGNvbnN0IHBlbmRpbmcgPSBPYmplY3Qua2V5cyh0aGlzLnN1YnNjcmlwdGlvbnMpXG4gICAgICAgICAgICAuZmlsdGVyKGtleSA9PiB0aGlzLnN1YnNjcmlwdGlvbnNba2V5XS5jb3VudCA+IDApO1xuXG4gICAgICAgIGlmKHBlbmRpbmcubGVuZ3RoID4gMCl7XG4gICAgICAgICAgICB0aGlzLnNvY2tldC5lbWl0KCdzdWJzY3JpYmUnLCBwZW5kaW5nLmpvaW4oKSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIHN1YnNjcmliZUlmUmVhZHkodG9waWM6IHN0cmluZyl7XG4gICAgICAgIGlmKCF0aGlzLmlzUmVhZHkpe1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5zb2NrZXQuZW1pdCgnc3Vic2NyaWJlJywgdG9waWMpO1xuICAgIH1cblxuICAgIHByaXZhdGUgZ2V0T3JDcmVhdGVPYnNlcnZhYmxlKHRvcGljOiBzdHJpbmcpOiBPYnNlcnZhYmxlPFJlYWx0aW1lUXVvdGVSZXNwb25zZT57XG4gICAgICAgIHRvcGljID0gdG9waWMudG9VcHBlckNhc2UoKTtcbiAgICAgICAgbGV0IG9ic2VydmFibGUgPSB0aGlzLnN1YnNjcmlwdGlvbnNbdG9waWNdO1xuXG4gICAgICAgIGlmKCFvYnNlcnZhYmxlKXtcbiAgICAgICAgICAgIHRoaXMuc3Vic2NyaXB0aW9uc1t0b3BpY10gPSBvYnNlcnZhYmxlID0gY3JlYXRlRW50cnkoe1xuICAgICAgICAgICAgICAgIG9uUmVzdW1lbmQ6ICgpID0+IHRoaXMuc3Vic2NyaWJlSWZSZWFkeSh0b3BpYyksXG4gICAgICAgICAgICAgICAgb25FbXB0eTogKCkgPT4gdGhpcy5zb2NrZXQuZW1pdCgndW5zdWJzY3JpYmUnLCB0b3BpYylcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIG9ic2VydmFibGUub2JzZXJ2YWJsZTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXQgYW4gT2JzZXJ2YWJsZSB0aGF0IHByb2R1Y2VzIHZhbHVlcyB3aGVuZXZlciBvbmUgb2YgdGhlXG4gICAgICogc2VjdXJpdGllcyBwYXNzZWQgYXMgcGFyYW1ldGVyIGNoYW5nZXNcbiAgICAgKiBAcGFyYW0gdG9waWNzIFRoZSBzZWN1cml0aWVzIG9uZSB3aXNoZXMgdG8gc3Vic2NyaWJlXG4gICAgICovXG4gICAgcHVibGljIG9ic2VydmUoLi4udG9waWNzOiBzdHJpbmdbXSk6IE9ic2VydmFibGU8UmVhbHRpbWVRdW90ZVJlc3BvbnNlPntcbiAgICAgICAgcmV0dXJuIG1lcmdlKC4uLnRvcGljcy5tYXAodGhpcy5nZXRPckNyZWF0ZU9ic2VydmFibGUpKTtcbiAgICB9XG59Il19